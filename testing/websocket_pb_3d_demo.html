<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>3D åœ°å›¾å®¢æˆ·ç«¯ - ç¬¬ä¸€äººç§°è§†è§’</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            background: #050b16;
            color: #e6edf3;
            font-family: system-ui, -apple-system, "Microsoft YaHei";
        }

        #ui {
            position: fixed;
            top: 12px;
            left: 12px;
            width: 300px;
            background: rgba(5, 15, 30, .85);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 8px;
            padding: 10px;
            z-index: 100;
        }

        input,
        button {
            width: 100%;
            margin-top: 6px;
            padding: 6px;
            background: #0b1a2c;
            border: 1px solid rgba(255, 255, 255, .08);
            color: #e6edf3;
            border-radius: 6px;
        }

        button {
            cursor: pointer;
        }

        button:hover {
            background: #0f2540;
        }

        pre {
            margin-top: 8px;
            font-size: 11px;
            max-height: 160px;
            overflow: auto;
            background: #020814;
            padding: 6px;
        }

        #controls-hint {
            position: fixed;
            bottom: 12px;
            left: 12px;
            background: rgba(5, 15, 30, .85);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
        }

        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 1000;
        }

        #crosshair::before,
        #crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }

        #crosshair::before {
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            transform: translateX(-50%);
        }

        #crosshair::after {
            top: 50%;
            left: 0;
            height: 2px;
            width: 100%;
            transform: translateY(-50%);
        }

        #pointer-lock-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(5, 15, 30, .95);
            border: 2px solid rgba(255, 255, 255, .2);
            border-radius: 12px;
            padding: 30px;
            font-size: 16px;
            text-align: center;
            z-index: 999;
            display: none;
        }
    </style>
</head>

<body>

    <div id="ui">
        <input id="wsUrl" value="ws://www.mfavant.xyz:20025">
        <input id="userId" value="1">
        <input id="password" value="1">
        <button id="btnConnect">è¿æ¥</button>
        <button id="btnLogin">ç™»å½•</button>
        <button id="btnEnter">è¿›å…¥3Dåœ°å›¾</button>
        <pre id="log">æœªè¿æ¥</pre>
    </div>

    <div id="controls-hint">
        <strong>ç¬¬ä¸€äººç§°æ§åˆ¶ï¼š</strong><br>
        W/S/A/D - å‰åå·¦å³ç§»åŠ¨<br>
        Space - ä¸Šå‡ | Shift - ä¸‹é™<br>
        é¼ æ ‡ç§»åŠ¨ - æ—‹è½¬è§†è§’<br>
        ESC - è§£é”é¼ æ ‡<br>
        <span style="color: #20c997;">ç‚¹å‡»ç”»é¢é”å®šé¼ æ ‡</span>
    </div>

    <div id="crosshair"></div>

    <div id="pointer-lock-hint">
        <div style="font-size: 24px; margin-bottom: 15px;">ğŸ®</div>
        <div>ç‚¹å‡»ç”»é¢è¿›å…¥ç¬¬ä¸€äººç§°æ¨¡å¼</div>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">æŒ‰ ESC é€€å‡º</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>

    <script>
        // ===================== Proto =====================
        const protoText = `
syntax="proto3";
package avant;
enum ProtoCmd{
    PROTO_CMD_CS_REQ_LOGIN = 2001;
    PROTO_CMD_CS_RES_LOGIN = 2002;
    PROTO_CMD_CS_MAP3D_NOTIFY_INIT_DATA = 2012;
    PROTO_CMD_CS_REQ_MAP3D_INPUT = 2015;
    PROTO_CMD_CS_MAP3D_NOTIFY_STATE_DATA = 2016;
    PROTO_CMD_CS_MAP3D_ENTER_REQ = 2017;
    PROTO_CMD_CS_MAP3D_ENTER_RES = 2018;
}
message ProtoPackage{
  ProtoCmd cmd=1;
  bytes protocol=2;
}
message ProtoCSReqLogin{
  string userId=1;
  string password=2;
}
message ProtoCSMap3DNotifyInitData{
  string userId=1;
  int32 x=2;
  int32 y=3;
  int32 z=10;
}
message ProtoCSReqMap3DInput{
  int32 dirX=1;
  int32 dirY=2;
  int32 dirZ=3;
  uint32 seq=4;
  uint64 clientTime=5;
}
message ProtoMap3DPlayerPayload{
  string userId=1;
  int32 x=2;
  int32 y=3;
  int32 z=4;
  uint32 lastSeq=8;
}
message ProtoCSMap3DNotifyStateData{
  repeated ProtoMap3DPlayerPayload players=2;
}
message ProtoCSMap3DEnterReq{
  uint32 mapId=1;
}
message ProtoCSMap3DEnterRes{
  int32 ret=1;
  uint32 mapId=2;
}
`;

        const root = protobuf.parse(protoText).root;
        const ProtoPackage = root.lookupType("avant.ProtoPackage");
        const Cmd = root.lookupEnum("avant.ProtoCmd").values;
        const T_Login = root.lookupType("avant.ProtoCSReqLogin");
        const T_Init = root.lookupType("avant.ProtoCSMap3DNotifyInitData");
        const T_State = root.lookupType("avant.ProtoCSMap3DNotifyStateData");
        const T_Input = root.lookupType("avant.ProtoCSReqMap3DInput");
        const T_Enter = root.lookupType("avant.ProtoCSMap3DEnterReq");

        // ===================== UI / Log =====================
        const logEl = document.getElementById("log");
        function log(...a) {
            logEl.textContent =
                new Date().toLocaleTimeString() + " " + a.join(" ") + "\n" + logEl.textContent;
            if (logEl.textContent.length > 3000) {
                logEl.textContent = "";
            }
        }

        // ===================== Map State =====================
        const players = new Map();
        let selfId = null;
        let lastSeq = 0;

        // ===================== WebSocket =====================
        let ws = null;
        function sendInner(type, obj, cmd) {
            if (!ws || ws.readyState !== 1) {
                log("WebSocket æœªè¿æ¥");
                return;
            }
            const inner = type.encode(type.create(obj)).finish();
            const pkg = ProtoPackage.encode(
                ProtoPackage.create({ cmd, protocol: inner })
            ).finish();
            ws.send(pkg);
        }

        // ===================== WebSocket Handler =====================
        function handlePkg(msg) {
            switch (msg.cmd) {
                case Cmd.PROTO_CMD_CS_RES_LOGIN:
                    log("âœ“ ç™»å½•æˆåŠŸ");
                    break;
                case Cmd.PROTO_CMD_CS_MAP3D_NOTIFY_INIT_DATA:
                    const initData = T_Init.decode(msg.protocol);
                    selfId = initData.userId;
                    if (!players.has(selfId)) {
                        const mesh = createPlayerMesh(true);
                        mesh.position.set(initData.x, initData.y, initData.z);
                        players.set(selfId, mesh);
                    }
                    log("âœ“ åˆå§‹åŒ–ç©å®¶:", selfId, `ä½ç½®:(${initData.x},${initData.y},${initData.z})`);
                    break;
                case Cmd.PROTO_CMD_CS_MAP3D_NOTIFY_STATE_DATA:
                    const stateData = T_State.decode(msg.protocol);
                    log(`AOIç©å®¶ä¸ªæ•° ${stateData.players.length}`);
                    let playersPos = "";
                    stateData.players.forEach(p => {
                        let m = players.get(p.userId);
                        if (!m) {
                            m = createPlayerMesh(p.userId === selfId);
                            players.set(p.userId, m);
                            log("æ–°ç©å®¶åŠ å…¥:", p.userId);
                        }
                        m.position.set(p.x, p.y, p.z);
                        playersPos += `{${p.x},${p.y},${p.z}}`;
                    });
                    log(playersPos);
                    break;
                case Cmd.PROTO_CMD_CS_MAP3D_ENTER_RES:
                    log("âœ“ è¿›å…¥3Dåœ°å›¾æˆåŠŸ");
                    showPointerLockHint();
                    break;
                default:
                    log("æœªå¤„ç†åè®®:", msg.cmd);
            }
        }

        document.getElementById("btnConnect").onclick = () => {
            if (ws && ws.readyState === 1) {
                log("å·²ç»è¿æ¥");
                return;
            }
            ws = new WebSocket(document.getElementById("wsUrl").value);
            ws.binaryType = "arraybuffer";
            ws.onopen = () => log("âœ“ WS å·²è¿æ¥");
            ws.onclose = () => log("âœ— WS æ–­å¼€");
            ws.onerror = (e) => log("âœ— WS é”™è¯¯");
            ws.onmessage = ev => {
                const msg = ProtoPackage.decode(new Uint8Array(ev.data));
                handlePkg(msg);
            };
        };

        document.getElementById("btnLogin").onclick = () => {
            sendInner(
                T_Login,
                { userId: document.getElementById("userId").value, password: document.getElementById("password").value },
                Cmd.PROTO_CMD_CS_REQ_LOGIN
            );
            log("å‘é€ç™»å½•è¯·æ±‚");
        };

        document.getElementById("btnEnter").onclick = () => {
            sendInner(
                T_Enter,
                { mapId: 4 },
                Cmd.PROTO_CMD_CS_MAP3D_ENTER_REQ
            );
            log("è¯·æ±‚è¿›å…¥åœ°å›¾");
        };

        // ===================== Three.js =====================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050b16);
        scene.fog = new THREE.Fog(0x050b16, 100, 500);

        const camera = new THREE.PerspectiveCamera(
            75, window.innerWidth / window.innerHeight, 0.1, 1000
        );

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // æ·»åŠ ç½‘æ ¼è¾…åŠ©çº¿
        const gridHelper = new THREE.GridHelper(2000, 100, 0x1a3a5c, 0x0f243f);
        scene.add(gridHelper);

        // æ·»åŠ åæ ‡è½´è¾…åŠ©çº¿
        const axesHelper = new THREE.AxesHelper(50);
        scene.add(axesHelper);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dl = new THREE.DirectionalLight(0xffffff, 0.6);
        dl.position.set(50, 50, 100);
        scene.add(dl);

        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(2000, 2000),
            new THREE.MeshStandardMaterial({ color: 0x0f243f, transparent: true, opacity: 0.3 })
        );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // ===================== ç¬¬ä¸€äººç§°ç›¸æœºæ§åˆ¶ =====================
        let yaw = 0;   // æ°´å¹³æ—‹è½¬è§’åº¦
        let pitch = 0; // å‚ç›´æ—‹è½¬è§’åº¦
        const EYE_HEIGHT = 1.6; // çœ¼ç›é«˜åº¦ï¼ˆç›¸å¯¹äºç©å®¶ä½ç½®ï¼‰

        // çª—å£å¤§å°è‡ªé€‚åº”
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ===================== æŒ‡é’ˆé”å®š =====================
        const pointerLockHint = document.getElementById('pointer-lock-hint');

        function showPointerLockHint() {
            pointerLockHint.style.display = 'block';
        }

        renderer.domElement.addEventListener('click', () => {
            renderer.domElement.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === renderer.domElement) {
                pointerLockHint.style.display = 'none';
                log("âœ“ é¼ æ ‡å·²é”å®š - ç¬¬ä¸€äººç§°æ¨¡å¼");
            } else {
                log("é¼ æ ‡å·²è§£é”");
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === renderer.domElement) {
                const sensitivity = 0.002;
                yaw -= e.movementX * sensitivity;
                pitch -= e.movementY * sensitivity;

                // é™åˆ¶ä¿¯ä»°è§’åº¦ï¼Œé˜²æ­¢ç¿»è½¬
                pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, pitch));
            }
        });

        // ===================== Player Mesh Creation =====================
        function createPlayerMesh(isSelf) {
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshStandardMaterial({
                color: isSelf ? 0x20c997 : 0x3aa0ff,
                emissive: isSelf ? 0x0a4d3a : 0x1a5080,
                emissiveIntensity: 0.3
            });
            const m = new THREE.Mesh(geometry, material);

            // æ·»åŠ è¾¹æ¡†
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(
                edges,
                new THREE.LineBasicMaterial({ color: isSelf ? 0x40ffbf : 0x60c0ff })
            );
            m.add(line);

            // ç¬¬ä¸€äººç§°æ¨¡å¼ä¸‹ï¼Œè‡ªå·±çš„æ¨¡å‹è®¾ä¸ºä¸å¯è§
            if (isSelf) {
                m.visible = false;
            }

            scene.add(m);
            return m;
        }

        // ===================== Input =====================
        const key = {};
        window.addEventListener("keydown", e => {
            key[e.key.toLowerCase()] = true;
            if (e.key === ' ') e.preventDefault();
        });
        window.addEventListener("keyup", e => key[e.key.toLowerCase()] = false);

        const SPEED = 2;
        setInterval(() => {
            if (!selfId) return;

            let moveX = 0, moveY = 0, moveZ = 0;

            // æ ¹æ®è§†è§’æ–¹å‘è®¡ç®—ç§»åŠ¨å‘é‡
            const forward = new THREE.Vector3(
                Math.sin(yaw),
                0,
                Math.cos(yaw)
            );
            const right = new THREE.Vector3(
                Math.cos(yaw),
                0,
                -Math.sin(yaw)
            );

            // W/S - å‰åç§»åŠ¨ï¼ˆåŸºäºè§†è§’æ–¹å‘ï¼‰
            if (key.w) {
                moveX += forward.x * SPEED;
                moveZ += forward.z * SPEED;
            }
            if (key.s) {
                moveX -= forward.x * SPEED;
                moveZ -= forward.z * SPEED;
            }

            // A/D - å·¦å³å¹³ç§»ï¼ˆåŸºäºè§†è§’æ–¹å‘ï¼‰
            if (key.a) {
                moveX -= right.x * SPEED;
                moveZ -= right.z * SPEED;
            }
            if (key.d) {
                moveX += right.x * SPEED;
                moveZ += right.z * SPEED;
            }

            // Space/Shift - ä¸Šä¸‹ç§»åŠ¨
            if (key[" "]) moveY += SPEED;
            if (key.shift) moveY -= SPEED;

            // å‘é€ç§»åŠ¨æŒ‡ä»¤åˆ°æœåŠ¡å™¨
            lastSeq++;
            sendInner(
                T_Input,
                {
                    dirX: Math.round(moveX),
                    dirY: Math.round(moveY),
                    dirZ: Math.round(moveZ),
                    seq: lastSeq,
                    clientTime: Date.now()
                },
                Cmd.PROTO_CMD_CS_REQ_MAP3D_INPUT
            );
        }, 80);

        // ===================== Render Loop =====================
        function animate() {
            requestAnimationFrame(animate);

            const self = players.get(selfId);
            if (self) {
                // ç¬¬ä¸€äººç§°ï¼šç›¸æœºä½ç½®åœ¨ç©å®¶å¤´éƒ¨
                camera.position.set(
                    self.position.x,
                    self.position.y + EYE_HEIGHT,
                    self.position.z
                );

                // æ ¹æ® yaw å’Œ pitch è®¾ç½®ç›¸æœºæœå‘
                camera.rotation.order = 'YXZ';
                camera.rotation.y = yaw;
                camera.rotation.x = pitch;
            }

            renderer.render(scene, camera);
        }
        animate();

        log("âœ“ 3D åœºæ™¯å·²åˆå§‹åŒ–ï¼ˆç¬¬ä¸€äººç§°æ¨¡å¼ï¼‰");
        log("è¯·ä¾æ¬¡ç‚¹å‡»: è¿æ¥ â†’ ç™»å½• â†’ è¿›å…¥3Dåœ°å›¾");
    </script>

</body>

</html>